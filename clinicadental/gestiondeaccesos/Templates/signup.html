{% extends 'baseLogin.html' %}

{% block content %}

<main class="container">
    <div class="row">
        <div class="col-md-5 offset-md-3.5 mx-auto mt-5" style="max-width: 500px;">
            
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            <form method="POST" class="card shadow-lg border-0 rounded-3">
                <div class="card-body p-4 p-md-5">
                    
                    <h2 class="text-center mb-4 fw-bold text-dark">Registrar Admin</h2>
                    
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="username" class="form-label fw-medium">Usuario</label>
                        <input type="text" name="username" id="username" class="form-control" placeholder="Elige un nombre de usuario" required>
                    </div>

                    <div class="mb-3">
                        <label for="password1" class="form-label fw-medium">Contraseña</label>
                        <div class="input-group">
                            <input type="password" name="password1" id="password1" class="form-control" placeholder="Crea una contraseña segura" required>
                            <button class="btn btn-outline-secondary toggle-password" type="button" data-target="password1">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>

                        <div class="card bg-light mt-2 border-0" id="password-requirements" style="font-size: 0.85rem;">
                            <div class="card-body p-2">
                                <p class="mb-1 fw-bold text-muted">La contraseña debe contener:</p>
                                <ul class="list-unstyled mb-0 ps-1">
                                    <li id="rule-length" class="text-muted"><i class="bi bi-circle me-2"></i>Mínimo 8 caracteres</li>
                                    <li id="rule-upper" class="text-muted"><i class="bi bi-circle me-2"></i>Una letra mayúscula</li>
                                    <li id="rule-lower" class="text-muted"><i class="bi bi-circle me-2"></i>Una letra minúscula</li>
                                    <li id="rule-number" class="text-muted"><i class="bi bi-circle me-2"></i>Un número</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="password2" class="form-label fw-medium">Confirmar Contraseña</label>
                        <div class="input-group">
                            <input type="password" name="password2" id="password2" class="form-control" placeholder="Repite la contraseña" required>
                            <span class="input-group-text bg-white border-start-0" id="match-icon" style="display:none;">
                                <i class="bi bi-check-circle-fill text-success"></i>
                            </span>
                        </div>
                        <div id="password-match-warning" class="form-text text-danger" style="display:none;">
                            Las contraseñas no coinciden.
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primario btn-lg" type="submit" id="btn-submit">
                            Registrar Usuario
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</main>

<style>
    .valid-rule {
        color: #198754 !important; /* Verde Success */
        font-weight: 500;
    }
    .valid-rule i::before {
        content: "\f26a"; /* Código del ícono 'check-circle-fill' de Bootstrap Icons */
    }
    .password-mismatch {
        border-color: #dc3545 !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password1');
    const confirmInput = document.getElementById('password2');
    const toggleBtns = document.querySelectorAll('.toggle-password');
    const matchWarning = document.getElementById('password-match-warning');
    const matchIcon = document.getElementById('match-icon');
    
    // Reglas (Elementos del DOM)
    const rules = {
        length: document.getElementById('rule-length'),
        upper: document.getElementById('rule-upper'),
        lower: document.getElementById('rule-lower'),
        number: document.getElementById('rule-number')
    };

    toggleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target'); // password1 o password2
            const input = document.getElementById(targetId); 
            const icon = this.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    });

    // Validación en tiempo real (Checklist)
    passwordInput.addEventListener('input', function() {
        const val = this.value;

        // Regla: Longitud >= 8
        updateRule(rules.length, val.length >= 8);

        // Regla: Mayúscula
        updateRule(rules.upper, /[A-Z]/.test(val));

        // Regla: Minúscula
        updateRule(rules.lower, /[a-z]/.test(val));

        // Regla: Número
        updateRule(rules.number, /[0-9]/.test(val));
        
        checkMatch();
    });

    // Validar coincidencia de contraseñas
    confirmInput.addEventListener('input', checkMatch);

    function checkMatch() {
        const pass1 = passwordInput.value;
        const pass2 = confirmInput.value;

        if (pass2.length > 0) {
            if (pass1 === pass2) {
                confirmInput.classList.remove('is-invalid', 'password-mismatch');
                confirmInput.classList.add('is-valid');
                matchWarning.style.display = 'none';
                matchIcon.style.display = 'block';
            } else {
                confirmInput.classList.remove('is-valid');
                confirmInput.classList.add('is-invalid', 'password-mismatch');
                matchWarning.style.display = 'block';
                matchIcon.style.display = 'none';
            }
        } else {
            confirmInput.classList.remove('is-invalid', 'is-valid');
            matchWarning.style.display = 'none';
            matchIcon.style.display = 'none';
        }
    }

    function updateRule(element, isValid) {
        if (isValid) {
            element.classList.add('valid-rule');
            element.classList.remove('text-muted');
        } else {
            element.classList.remove('valid-rule');
            element.classList.add('text-muted');
        }
    }
});
</script>

{% endblock %}